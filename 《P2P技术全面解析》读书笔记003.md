#### 3 P2P网络模型概述
##### 3.1 常见网络模型
包含：随机网络、规则网络和小世界网络
###### 3.1.1 随机网络
- 随机图：在随机图中，含有N个节点，边的出现是一个概率事件，具有任意边的图为概率空间，研究当N趋于∞时图的性质。与经典图间最大的区别在与引入了随机的方法，使得空间变得更大，数学性质也发生了巨大变化。
- 随机图理论的主要目标是确定在何种连接概率下，随机图将产生哪些特性，理论中还定义了连通性、度分布、集聚系数等各种网络模型中广为使用的概念。
- 随机网络：基于随机图理论，是一种能反应多种随机因素及随机变量的网络技术。包含了从空图到完全图的所有可能情况。
- 经典的随机网络：给定N个节点，没有边，任一两节点间都尝试以某个概率p连接，这样构成的网络就是随机网络。
- 研究结果随机网络顶点的度平均值为<k>=p(N-1)约等于pN，平均集聚系数C=p=<k>/N<<1，平均路径长度L正比于lnN/ln<k>，得出结论节点之间的平均路径长度比较短，平均集聚系数比较低，度数分布服从泊松分布。
- 尽管对于同样规模的网络，随机网络具有短的平均路径长度，但是，许多实际网络都具有很高的平均集聚系数，而随机网络却是一个局部集团化很差的网络，平均集聚系数很低。所以，随机网络不是实际网络的一个很好的刻画。是研究复杂网络拓扑的基本理论，其中一些基本思想依然很重要。

###### 3.1.2 规则网络
- 与随机网络相反，网络节点与边的关系是固定的，每个节有相同的度数，其平均集聚系数也只需在一点计算，其最短距离也可以只从某一顶点开始计算从他到所有其他顶点之间的距离之和，然后计算平均值，一般情况下具有大的集聚系数和长的平均最短路径。
- 常见的规则网络有最近邻耦合网络和星形耦合网络。
- 最近邻耦合网络，每个节点只和他周围的K（K为偶数）个邻居节点相连，左右各K/2个，具有周期边界条件的最近邻耦合网络包含N个围城一个环的节点，集聚系数C=3(K-2)/4(K-1)约等于3/4，对于固定的K值，网络的平均路径长度为L约等于N/2K趋近于无穷大，可以看出这种局部耦合的网络是高集聚的，很难实现，需要全局协调的动态过程。
- 星形耦合网络，有一个中心点，其余N-1个节点都只与这个中心点连接，彼此不连接，平均路径长度为L=2-2(N-1)/N(N-1)趋近于2，聚合系数为C=(N-1)/N趋近于1。
- 因此星形网络是高集聚的，并且有很小的平均路径长度，但是对中心节点的性能要求非常高。所以更关注最邻近耦合行网络。
- 对比随机网络与规则网络，平均集聚系数与平均最短距离，这两个静态集合量可以很好的反应规则网络与随机网络的性能及差异。

###### 3.1.3 小世界网络
++是数学中一种图的类型，图中大部分的节点不育彼此邻接，但大部分节点可以从任一其他点经少数几步到达。++ 将点代表一个人，线代表人与人认识，则小世界网络反应陌生人由彼此共同认识的人而连接的小世界现象。
1. 引入小世界网络模型
    1. 以描述从完全规则网络到完全随机网络的转变。模型中主要的特征是在规模为N的网络中，节点间的平均距离L随远程连接的节点个数K的增加呈指数级下降，即对小世界网络，L～ln(N)/ln(K)。小世界概念描述了一个***事实***：++在大多数网络中，尽管规模很大，但任意两节点间总有一条相当短的路径。另外小世界网络具有相对较高的集聚系数。++
    2. 非结构化的P2P网络中，普遍采用泛洪算法进行路由，与DHT路由算法相比，可靠行差，并且网络资源消耗较大。而小世界模型特征指出，网络拓扑具有高集聚系数和短链的特性。研究表明，以Gnutella为代表的非结构化P2P网络符合***小世界的特征***，意味着网络中++存在大量的高连通节点，部分节点之间存在短链现象。++
    3. 由小世界模型的引入，P2P网络路由算法的本质，从如何缩短路径的长度变为如何找到短链的问题。
2. 小世界网络拓扑
    1. 小世界网络的构建基于这样的***原则***：++每个节点都表现出某些可以被捕捉到的兴趣，而兴趣相近的节点的内容和提交的查询也呈现出一定的相关性。通过挖掘每个节点的兴趣，将节点按照他们所表现出的相关性组成网络，使得相关性较高的节点在网络中比较近。++ 这种按节点间的相关性所组成的网络表现出和社会网络相近的特性，即***小世界特性***。这些特性被证明对于提高检索效率非常有效。
    2. 小世界的网络拓扑表明，只需要++在规则网络上稍作随机改动，网络就同时具有随机性和规则性两种特性。++ ***改动方法***是：对于规则网络的每一个顶点的所有边，以概率p断开一个端点并重新连接，连接新的端点从网络中的其他顶点理随机选择，如果所选的顶点已经与此顶点相连，则再随机选择别的顶点来重连。当p=0时就是规则网络，p=1时就是随机网络，对于0<p<1的情况，存在一个很大的p的区域，同时拥有较大的集聚系数和较小的最短距离。
3. 小世界网络的统计性质
    1. 集聚系数，++用实际存在的边数处以最多可能存在的边数得到的数值，定义为这个节点的集聚系数，所有节点的集聚系数的均值定义为网络的平均集聚系数。++ 小世界网络的集聚系数为：
    ```math
    C(p)=[3(K-2)/4(K-1)](1-p)^3
    ```
    C(0)约等于3/4，C(1)=0，当0<p<1时，存在一个很大的p的区域，使得网络拥有较大的集聚系数。
    2. 平均路径长度，定义为++网络中任意两点的平均最短路径长度++，
    
    ```math
    L(p)=\frac {1} {\frac{1}{2}N(N+1)}\sum_{i \geq j}d(p)_{ij}
    ```
    其中，d(p)为从节点i到j的几何距离，p为重连概率，当p=0时为规则网络，平均路径长度L～N/2K>>1，K为常数，当p=1时，L～ln(N)/ln(K)，随节点N增加，网络规模扩大，平均路径长度L随N呈对数增长。
    3. 度分布，假设某个节点有K条边，通过重连变为k条边，当k>=K/2时，
    ```math
    P(k) = \sum_{n=0}^{min(k-K/2,K/2)}\begin{pmatrix} K/2 \\ n \end{pmatrix}(1-p)^np^{(K/2)-n}\frac {(pK/2)^{k-(K/2)-n}} {(k-(K/2)-n)!} e^{-pK/2}
    ```
    当k<K/2时，P(k)=0。类似于规则网络，小世界网络也是所有节点的度都近似相等的均匀网络。
4. 小世界网络现状
目前针对小世界网络的主要研究是按照对用户检索行为的分析来划分用户兴趣，这在一定程度上提高了检索效率。但检索行为只能反应用户部分兴趣，尤其对提供大量信息的节点，只能展示他的一个很小子集。如何准确的定位节点的兴趣集合，动态的反应网络中的资源情况，公平的分担网络负载，成为小世界网络研究所急需解决的关键点。

###### 3.1.4 三种网络模型同统计性质
性质 | 平均距离 | 集聚系数 | 度分布
--- | --- | --- | ---
随机网络 | 小 | 小 | 泊松分布
规则网络 | 大 | 大 | Delta分布
小世界网络 | 小 | 大 | 指数分布

##### 3.2 集中目录式P2P网络模型
###### 3.2.1 原理

1. 中央目录服务器管理P2P网络个节点，仍然具有中心化特点，非纯粹的P2P结构。中央目录服务器保留索引信息，对等节点负责保存各自提供服务的全部资料，服务器与对等节点以及对等节点间具有交互能力。
2. 采用星形结构，群组中对等节点都与中心目录服务器相连，并向其发布分享的文件列表。查询节点可向中心目录服务器发起文件检索请求，得到回复后，查询节点根据网络流量和延迟等信息选择合适的节点建立直接连接，不必经过中央服务器进行，文件交换即可直接在两个对等节点进行。过程中中央目录服务器负责记录群组所有参与者信息，进行适当管理。
3. 集中目录式网络结构简单，显示了P2P系统信息量巨大的优势和吸引力。最大***优点***是维护简单、发现效率高，发现算法灵活高效并能够实现复杂查询。提高了网络的可管理型，使得对共享资源的查找和更新非常方便。
4. 同时存在很多***问题***，综合对小型网络，在管理和控制方面占有一定优势，但不适合大型网络，表现如下：
    1. ++可靠性和安全性低++，与传统C/S结构类似，容易造成单点故障，中央目录服务器失效则该服务器下的对等节点将全部失效。
    2. ++维护成本高++，随着网络规模扩大，对中央目录服务器进行维护和更新的费用积聚增加。
    3. ++存在法律版权和资料浪费问题++，大量版权资料可通过中央目录服务器轻易取得。

###### 3.2.2 典型应用：BitTorrent
- Tracker: 收集下载者信息的服务器，并将信息提供给其他下载者，使下载者们相互连接起来，传输数据。
- 种子：指一个下载任务中所有文件都被某下载者完整的下载，此时下载者成为一个种子，发布者本身发布的文件就是原始种子。
- 做种：发布者提供下载任务完成的全部内容行为，下载者下载完成后继续提供给他人下载的行为。
- .torrent文件：未见发布者生成，包含了要下载文件的信息，包括文件名、大小、文件的散列信息以及指向Tracker服务器的URL。
- 工作模式：普通的HTTP/FTP下载使用TCP/IP，BitTorrent协议是架构于++TCP/IP之上的一个P2P文件传输协议，处于TCP/IP结构的应用层++。根据BitTorrent协议，发布者生成一个.torrent文件，包好Tracker信息和文件信息两部分。Tracker信息主要是BT下载中需要的Tracker服务器的地址和针对Tracker服务器的设置；文件信息是根据对目标文件计算生成的，计算结果根据BitTorrent协议内的***B编码***规则进行编码，主要原理++将目标文件分为256KB的块，块在整个文件中是顺序排列的，每个块都有相应的编号（虚拟分块）。一个块还可以分为多个16KB的子块，并把每个块的索引信息和Hash验证码写入文件中，所以.torrent文件就是被下载文件的索引++。由于整块数据需要用摘要验证正确性，而只有验证正确的数据才能提供给其他节点的下载，为尽快共享整块数据，就应该尽量把一整块下载完整，再下载其他的块。所以下载时总是优先下载同一块内的其他的子块。
- 下载过程中下载者周期性的向++Tracker登记++，使其了解进度，起初只有发布者拥有全部文件，随着传输，部分下载者获得部分文件，随着传输继续，++文件会全部公布在系统中++，当发布者退出网络，不影响文件的传播。
- DHT的出现使得无Tracker下载成为可能，系统可在DHT网络中寻找下载统一文件的其他客户端并进行通信，完成下载。

##### 3.3 纯P2P网络模型
纯P2P网络模型中，每个节点都同时扮演着客户端和服务器的角色。++节点间的通信完全对等++，无需仲系服务器的任何帮助，++每个节点都维护着一个邻居列表，节点通过和他的邻居进行交互完成特定行为++。解决中心化问题，扩展性和容错性好。进一步区分为++非结构化覆盖网络++和++结构化覆盖网络++。

###### 3.3.1 纯P2P非结构化网络模型
1. 也称为广播式P2P模型，没有专门的目录服务器，对等节点间的内容查询和内容共享都是直接通过++临近节点广播接力完成的++。
2. 用户随机接入网络，并于自己相邻的一组邻居节点通过端到端的连接构成一个逻辑覆盖网络。非结构化覆盖网络中，节点维护的邻居是随意的无规则的，信息资源在P2P网络中的存放位置和网络本身的拓扑结构无关。没有一个对等节点知道整个网络的结构或组成网络的每个对等节点的身份，对等节点必须使用他们所在的网络来定位其他对等点。希望知道网络中的另一个对等节点的位置时，改查询节点就发出查询请求并直接广播到所连接的邻居节点，这些邻居尝试满足这个请求。如果不可以，就以相同的方式广播到各自的邻居节点，以此类推。为防止搜索环路的产生，每个节点会记录搜索轨迹，直到收到应答或达到最大步数。
3. Gnutella模型是对应最广泛的纯P2P非结构化网络模型。基于完全随机图的泛洪发现和随机转发机制，通过IP多播技术让对等点定期发布资源和传播查询。
4. 综上：
    - 完全的分布性使之具有最大的容错性，不会出现单点崩溃现象；
    - 能潜在的获得最多的查询结果；
    - 整个网络的扩展性差，随着对的节点数量的增加，网络可能因过多的查询消息而发生拥塞；
    - 由于模型中没有中央目录服务器对用户进行管理，因此缺乏较好的集中控制和策略；
    - 查询的有效期和正确性都不能保证；
    - 能力有限的对等节点易成为系统瓶颈；
    - 网络中对等点的查找和定位比较复杂，效率低。

###### 3.3.2 纯P2P结构化网络模型
1. 由于非结构化网络模型，采用广播请求模式的随机搜索造成网络不可扩展，所以研究工作集中在如何构造高度结构化的网络模型，所以产生了纯P2P结构化网络模型。与非结构化的***区别***在于++每个节点所谓户的邻居是否能够按照某种全局方式组织起来以利于快速查找++。结构化模型，采用++纯分布式的消息传递机制和根据关键字进行查找的定位服务。在结构化的网络模型中，节点维护的邻居是有规律的，P2P网络的拓扑结构是受到严格控制的，信息资源将有规则的被组织存放到合适的节点。查询将以较少的跳数，路由到负责所查询信息资源的节点上。++
2. 目前结构化P2P的主流方法是采用分布式散列表DHT技术。目前最好的P2P路由方式，通过++分布式散列函数，将输入的关键字唯一映射到某个节点上，然后通过某些路由算法同该节点建连接。++
3. DHT主要***思想***：++每条文件索引被表示成一个（关键字，实际存储文件的节点IP）对，所有文件索引条目组成一张大的文件索引散列表。通过关键字查找IP。网络中每个节点根据性能不同被分配维护部分散列表，分配方式根据不同DHT算法决定。++
4. 综上：
    - 较少的路由信息可以有效的实现到达目标节点；
    - 取消泛洪算法，利用分布式散列表进行定位查找，有效减少节点信息发送数量，从而增强了网络的扩展性；
    - 出于冗余度和延时的考虑，DHT总是在节点的虚拟标示与关键字最接近的节点上备份复制冗余信息，避免了单一节点失效问题；
    - 使用者匿名，数据加密传输；
    - 最大问题在于维护机制复杂，尤其是节点频繁加入、退出造成的网络波动会极大增加DHT维护代价；
    - 另一个问题是DHT仅支持精确关键词匹配查找；
    - 自身算法限制，不适用于大型P2P系统。

##### 3.4 分层式P2P网络模型
###### 3.4.1 原理
- 吸收集中目录式P2P网络模型和纯P2P网络模型的优点，在设计和处理能力上都进行了优化，按***节点能力***不同区分为++超级节点++和++普通节点++；在++资源共享方面，所有节点地位相同++，***区别***在于，++超级节点上存储了系统中其他部分节点的信息++。++发现算法仅在超级节点中间转发++，超级节点再将查询请求转发给适当的普通节点，这样++超级节点间构成一个高速转发层++，根据超级节点再选取***性能最优节点***，保存超级节点信息，负责++维护整个网路结构++，构成若干层次。
- KaZaa是这种模型的典型代表。

###### 3.4.2 查询机制
分层网络中，一个或几个超级节点与其临近的若干普通节点之间构成一个自制的簇。簇内节点可以自治的进行消息查询；整个P2P网络中各个不同的簇之间通过纯P2P的模式将超级节点相连进行消息查询。

根据簇的规模不同，各个簇采用不同的查询机制：
- 如果一个簇内只有少量节点（几十个），每个节点可以维护一个本地路由表，通过一致散列函数分配定位对，是的查询簇内的其他任一节点的跳数为O(1)。
- 簇内较多节点（几百个），可利用超级节点查询簇内的其他节点，这时要查询节点向簇内的超级节点发送查询请求，就可以在O(1)内查到目的节点。
- 簇内有大量节点（上千个），可在簇内使用Chord、CAN、Pastry或Tapestry这类算法，查找跳数会是O(logN)，N为簇内节点数。

###### 3.4.3 簇管理
- 若节点x要加入一个分层式P2P网络，假定其应归属的超级节点的ID值为k，首先，x用k与网络中已经存在的另一个节点y取得联系，y定位并返回对应于k的簇中超级节点的ID。如果返回ID恰好与k相同，那么x就使用普通节点加入机制加入该超级节点所在的簇，并将自己信息返回超级节点。如果返回ID不是k，则会生成新的簇，这个簇只包含一个节点x。
- 一个簇内如果有m个超级节点，先加入簇的m个节点将会成为超级节点，超级节点维护着超级节点候选名单，一个节点在网络中持续时间越长，拥有资源越多。容易被选为超级节点，一旦超级节点退出，名单中第一个候选节点将成为超级节点，并通知簇内所有节点。

###### 3.4.4 性能分析
- 有效的消除了纯P2P结构中使用泛洪算法带来的网络拥塞、搜索赤化等不理影响。
- 确保一些恶意攻击行为在网络局部得到控制，一定程度提高网络负载平衡。
- 充分利用了节点能力的差异性，提高了数据定位效率。
- 综上分层网络模型的***优缺点***：
    - ++按性能对节点进行分类++。合理分担负载。
    - ++各簇相对独立++。簇改变内部查询机制，与其他簇和上层查询向独立，节点失效，也不会影响其他簇。
    - ++提高了查询速度++。划分簇，簇内节点远少于总节点数，减少了路由跳数。
    - ++减少了查询消息传播的数量++。减少了重发消息数量，更少的跳数，意味着每次请求最少的消息交换。
    - ++实现比较困难++，需要提供能够有效组织节点间关系的搜索网络。
- 性能比较：

比较标准 | 集中目录式 | 全分布式非结构化 | 全分布式结构化 | 分层式
--- | --- | --- | --- | ---
可扩展性 | 差 | 差 | 好 | 中
可靠性 | 差 | 好 | 好 | 中
可维护性 | 最好 | 最好 | 好 | 中
发现算法效率 | 最高 | 中 | 高 | 中
复杂查询 | 支持 | 支持 | 不支持 | 支持
